### 图表组件D3研究

##### 简介

近年来，可视化越来越流行，许多门户网站、新闻、媒体都大量使用可视化技术，使得复杂的数据和文字变得十分容易理解，有一句谚语“一张图片价值于一千个字”，的确是名副其实。各种数据可视化工具也如井喷式地发展，D3
，ECharts正是其中的佼佼者。

D3 的全称是（Data-Driven
Documents），顾名思义是一个被数据驱动的文档。其实是对数据进行可视化的JavaScript库。D3将强大的可视化和交互技术与数据驱动的DOM操作方法相结合，能最大限度地使用现代浏览器的性能同时为设计可视化界面保留了最大的自由度。D3强调Web标准，所以无需将自己与专有框架联系起来。

官网：<https://d3js.org/>

GitHub：<https://github.com/d3/d3>

官方示例：<https://github.com/d3/d3/wiki/Gallery>

D3示例demo网站：<https://bl.ocks.org/> 、<http://blockbuilder.org/search>

插件：<https://github.com/d3/d3-plugins>

ECharts，一个使用 JavaScript 实现的开源可视化库，可以流畅的运行在 PC
和移动设备上，兼容当前绝大部分浏览器，底层依赖轻量级的矢量图形库 [ZRender](https://github.com/ecomfe/zrender)，提供直观，交互丰富，可高度个性化定制的数据可视化图表。ECharts提供完善的中文文档，能够快速通过配置实现支持的图表。

官网：<http://echarts.baidu.com/index.html>

GitHub : <https://github.com/apache/incubator-echarts>

##### 开发流程

对于ECharts，hightchart这类经过进一步封装的可视化库开发流程

1.  根据需求确定图表类型(例如折线d3.line)

2.  查找所需图表类型配置和数据格式要求，按照要求进行配置项配置，转换数据到指定格式

3.  在该类图表支持的动画、事件交互中选择需要的进行配置

对于D3

1.  根据需求确定图表类型(例如折线d3.line)

2.  把输入的原始数据转化成为标准的D3可接受的数据格式一般图像是对象数组

3.  根据原始数据定义好x轴函数、y轴函数和定义好作图方式在SVG上，画出x轴y轴、根据原始数据结合x轴及y轴函数作线状图

4.  再画出标题等细节的东西

5.  给已经完成的图形添加动画效果和事件交互

（可参看demo网站中有没所需图的示例，插件中有没有所需图表动画的实现，可节省很多时间）

##### 难易程度

ECharts，hightchart这类可视化库，经过配置即可完成图表的绘制，D3要稍微麻烦一点。

使用D3绘图需要

-   熟悉SVG（canvas）作图、熟悉CSS

>   D3.js提供了绘图中常用的计算工具函数，和方便操作SVG的方法（v4以后的D3也支持canvas，但不是所有的方法都支持），但是就SVG绘图的知识比较熟悉才能比较方便实现所需的效果。就像使用JQuery开发也需要一定的DOM熟练度一样。

>   D3的样式颜色和一大部分动画通过CSS来设置。

-   熟悉D3的API

>   D3提供了很多可视化常用的计算方法和工具方法，熟悉之后才能事半功倍

-   学习D3.js的编程风格

D3的语法大部分是函数式编程，了解一下函数式编程的curry与compose思想，除getter基本都可以链式调用这点类似于jQuery，理解选择器绑定数据后
Update，Enter 和 Exit 的用法，然后要学习D3的画图一般思路，就像前面的开发流程。

总结：D3和
ECharts，hightchart这类可视化库相比属于可视化中较为基础的工具库，需要一定的可视化方面的基础才能比较快速开发出较复杂的图表，可以先尝试实现简单的图形，官网首页上面就大部分酷炫的在线Demo，难度较高可以先从demo网址找些简单点来实现

##### 对比ECharts优劣

对比D3和ECharts之前，先对比下两种浏览器图形渲染技术Canvas和SVG的主要区别，基本上所有的浏览器可视化第三方库都是基于这两种浏览器图形渲染技术实现的（WebGl虽然和2D的canvas没啥关系，广义上也算Canvas）：

| SVG                                                                            | Canvas                                                                                                    |
|--------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------|
| 矢量图不依赖分辨率，放大不失真                                                 | 位图依赖分辨率                                                                                            |
| 基于XML支持DOM事件处理器，SVG中每个图形节点都是单独的DOM节点可以附加js事件     | 不支持事件处理器 如果要为细粒度的元素添加事件，就需要边缘检测算法，无疑增加了难度而且不一定能保证十分精确 |
| 适合带有大型渲染区域的应用（比如：地图（每个节点区域都比较大，节点不是很多）） | 最适合图像密集型的应用比如游戏 能够方便的保存结果图像                                                     |
| 复杂度高会减慢渲染速度（任何过度使用DOM的应用都快不了）                        | 一旦图形绘制完成，就不会再得到浏览器的关注 如果位置或者大小变化整个区域都要重新绘制                       |
| 可以使用CSS 文本渲染能力较强                                                   | 文本渲染能力较弱                                                                                          |

简单对比后：

SVG比较适合 数据量不是很大，应用存在大量的用户交互场景。

Canvas比较适合事件交与较少，文本较少，或者数据量大画面刷新快的场景。

| ECharts                                    | D3                                                                                                                                        |
|--------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| Canvas为主4.0+也支持SVG                    | SVG为主4.0+也支持Canvas                                                                                                                   |
| 提供很多图表通过简单配置可以满足大部分需求 | 不能通过简单配置实现大部分图表                                                                                                            |
| 基本不可定制                               | 自由度很大，基本可以自己绘制任何图表                                                                                                      |
| 提供完善中文文档，示例功能完善             | 提供完善英文文档，3.x版本中文文档比较完善，之后翻译的不完善，部分翻译可能需求查看英文方便理解，大部分示例需要完善才能使用，主要是参考价值 |
| 开发效率高，通过快速配置即可完成           | 大部分图表需要开发                                                                                                                        |
| 大数据量性能较好                           | 需要实现时手动优化 例如virtual DOM                                                                                                        |
| 提供基于WebGl的GL版实现3D图表              | 借助其他库来实现例如：[three.js](https://threejs.org/)、[glMatrix](http://glmatrix.net)、[Sylvester](http://sylvester.jcoglan.com/)       |

1.  对于ECharts支持的图表：

使用ECarts有较大的优势，开发效率高，动画、事件等实现也比较完善，正常情况下基本没有bug。

1.  对于Echarts不支持的图表：

    1.  数据量不是特别大或者事件交互比较精细的场景采用D3
        SVG来实现，可以先在官方示例和demo搜索有没有类似的图表实现。对于频繁的
        DOM
        操作十分消耗性能。对于用户体验的影响便是可能出现闪烁、卡顿等现象。可以参考前端界对于页面DOM卡顿的解决方案：
        Virtual DOM 技术。通过支持 Virtual Dom 技术的框架如Vue与 D3.js
        结合。使用D3来计算，Vue等Virtual DOM框架管理SVG节点和属性。

    2.  对于数据量比较大的场景，可以采用D3
        Canvas来实现，或者[ZRender](https://github.com/ecomfe/zrender)（ECharts使用的矢量图形库）来定制，这个需要比较熟悉Canvas绘图，而且需要注意性能的优化。

##### 总结

ECharts等提供的图表的确可以满足大部分的需求，遵循了数据可视化的一些经典范式，一切皆可配置。然而，每个不同的行业对于数据可视化都会有一些定制化的需求，希望能以一些带有行业特征的图表向使用者展示数据背后隐藏的秘密，但是ECharts这类图形库基本不可定制，而D3自由度度很大，基本可以自己绘制任何想要的图形，这类情况的需求可以使用D3进行二次开发，定制适合的图表，但是开发成本会稍高。因此，开发中要根据实际情况来判断。无论采用哪种方式开发都要做好二次封装，把实现的图表成可复用的组件。

##### 相关文档：

W3C SVG标准<https://www.w3.org/Graphics/SVG/>

可缩放矢量图形**（Scalable Vector Graphics，SVG)**
<https://developer.mozilla.org/zh-CN/docs/Web/SVG>

W3C Canvas <https://www.w3.org/TR/2dcontext/>

MDN
Canvas教程<https://developer.mozilla.org/zh-CN/docs/Web/API/Canvas_API/Tutorial>

WebGl简介 <http://www.khronos.org/webgl/>
,<https://www.w3.org/community/declarative3d/wiki/Related_technologies>

MDN WebGl教程 <https://developer.mozilla.org/zh-CN/docs/Web/API/WebGL_API>
